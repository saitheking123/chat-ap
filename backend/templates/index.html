<!DOCTYPE html>
<html>
<head>
    <title>Meta-Style Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        /* Your existing CSS here */
    </style>
</head>
<body>
<div id="chat">
    <div id="header">Meta-Style Chat</div>
    <div id="messages"></div>
    <form id="input-area" autocomplete="off">
        <label for="image-upload" id="image-upload-btn" title="Send image">ðŸ“·</label>
        <input id="image-upload" type="file" accept="image/*">
        <input id="input" placeholder="Type a message..." autocomplete="off">
        <button id="send" type="submit">âž¤</button>
    </form>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
<script>
    var socket = io();
    var messages = document.getElementById('messages');
    var input = document.getElementById('input');
    var form = document.getElementById('input-area');
    var me = localStorage.getItem('chatuser') || prompt("Enter your name:") || "Anonymous";
    localStorage.setItem('chatuser', me);

    // Load history
    fetch('/history').then(r => r.json()).then(function(data) {
        data.forEach(function(m) {
            addMessage(m);
        });
        messages.scrollTop = messages.scrollHeight;
    });

    function addMessage(m) {
        var div = document.createElement('div');
        div.className = 'msg-bubble' + (m.user === me ? ' me' : '');
        if (m.text) div.textContent = m.text + ' (' + m.user + ')';
        if (m.image_url) {
            var img = document.createElement('img');
            img.src = m.image_url;
            img.className = 'msg-img';
            div.appendChild(img);
            var span = document.createElement('span');
            span.textContent = ' (' + m.user + ')';
            div.appendChild(span);
        }
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    form.onsubmit = function(e) {
        e.preventDefault();
        if (input.value.trim()) {
            socket.emit('message', {user: me, text: input.value});
            input.value = '';
        }
    };

    socket.on('message', function(m) {
        addMessage(m);
    });

    // Image upload
    document.getElementById('image-upload-btn').onclick = function() {
        document.getElementById('image-upload').click();
    };
    document.getElementById('image-upload').onchange = function() {
        var fileInput = this;
        if (fileInput.files.length === 0) return;
        var formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('user', me);
        fetch('/upload', {
            method: 'POST',
            body: formData
        }).then(() => {
            fileInput.value = '';
        });
    };
</script>
</body>
</html>